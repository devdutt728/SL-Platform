@echo off
set "ROOT=D:\SL Platform"
set "LOGDIR=%ROOT%\logs"
if not exist "%LOGDIR%" mkdir "%LOGDIR%"

powershell -NoProfile -Command "& { $ErrorActionPreference = 'Continue'; $ports = 3000,3001,3002,3003,8001,8002,8010; foreach ($p in $ports) { Get-NetTCPConnection -LocalPort $p -ErrorAction SilentlyContinue | ForEach-Object { $procId = $_.OwningProcess; if ($procId) { try { Stop-Process -Id $procId -Force -ErrorAction SilentlyContinue } catch {} } } }; $root = '%ROOT%'; $gtkBin = 'C:\Program Files\GTK3-Runtime Win64\bin'; if (Test-Path $gtkBin) { $env:Path = $gtkBin + ';' + $env:Path }; $logDir = Join-Path $root 'logs'; New-Item -ItemType Directory -Force -Path $logDir | Out-Null; $caddyPath = Join-Path $root 'tools\caddy.exe'; function EnsureCaddy($path) { $needsDownload = $false; if (-not (Test-Path $path)) { $needsDownload = $true } else { try { & $path version | Out-Null } catch { $needsDownload = $true } }; if ($needsDownload) { $tools = Split-Path $path -Parent; New-Item -ItemType Directory -Force -Path $tools | Out-Null; $release = Invoke-WebRequest -Uri 'https://api.github.com/repos/caddyserver/caddy/releases/latest' -UseBasicParsing; $json = $release.Content | ConvertFrom-Json; $version = $json.tag_name.TrimStart('v'); $zipUrl = "https://github.com/caddyserver/caddy/releases/download/v$version/caddy_${version}_windows_amd64.zip"; $zipPath = Join-Path $tools "caddy_${version}_windows_amd64.zip"; Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath; $dest = Join-Path $tools 'caddy-extract'; if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }; Expand-Archive -Path $zipPath -DestinationPath $dest -Force; Copy-Item -Path (Join-Path $dest 'caddy.exe') -Destination $path -Force } ; return $path }; if (-not (Test-Path $caddyPath)) { $caddyPath = (Get-Command caddy -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Source) }; if (-not $caddyPath) { $caddyPath = (Join-Path $root 'tools\caddy.exe') }; $caddyPath = EnsureCaddy $caddyPath; function StartTask($cmd,$wd,$log){ $out = Join-Path $logDir ($log + '.log'); $err = Join-Path $logDir ($log + '.err.log'); $proc = Start-Process -FilePath 'powershell' -ArgumentList '-NoProfile','-Command',$cmd -WorkingDirectory $wd -RedirectStandardOutput $out -RedirectStandardError $err -WindowStyle Hidden -PassThru; return $proc.Id }; $p = @{}; $p.IT_BACKEND = StartTask '$env:PYTHONUNBUFFERED=1; uvicorn app.main:app --reload --port 8001 --access-log --log-level info' (Join-Path $root 'SL_IT\backend') 'it-backend'; $p.REC_BACKEND = StartTask '$env:PYTHONUNBUFFERED=1; uvicorn app.main:app --reload --port 8010 --access-log --log-level info' (Join-Path $root 'SL_Recruitment\backend') 'recruitment-backend'; $p.IT_FRONTEND = StartTask '$env:PORT=3001; npm run dev' (Join-Path $root 'SL_IT\frontend') 'it-frontend'; $p.REC_FRONTEND = StartTask '$env:PORT=3002; npm run dev' (Join-Path $root 'SL_Recruitment\frontend') 'recruitment-frontend'; $p.WORKBOOK = StartTask '$env:PORT=3003; npm run dev' (Join-Path $root 'SL_Workbook\frontend') 'workbook-frontend'; if ($caddyPath) { $out = Join-Path $logDir 'caddy.log'; $err = Join-Path $logDir 'caddy.err.log'; $proc = Start-Process -FilePath $caddyPath -ArgumentList @('run','--config','Caddyfile') -WorkingDirectory $root -RedirectStandardOutput $out -RedirectStandardError $err -WindowStyle Hidden -PassThru; $p.CADDY = $proc.Id }; $p | ConvertTo-Json | Set-Content -Path (Join-Path $logDir 'pids.json') -Encoding UTF8 }"

start "SLP Live Logs" "%ROOT%\monitor.cmd"

